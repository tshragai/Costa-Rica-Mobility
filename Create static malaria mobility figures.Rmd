---
title: "Create Static Malaria/Mobility Figures"
output: html_document
date: "2025-11-17"
---

```{r setup, include=FALSE}
# ------------------------------------------------------------------------------
# Setup: Load libraries and set paths
# ------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)

# Load required libraries
library(dplyr)
library(sf)
library(lubridate)
library(ggplot2)
library(leaflet)
library(viridis)

# Set project root and data directory paths
proj_root <- "~/Costa-Rica-Mobility"
data_dir  <- file.path(proj_root, "Data")
```

```{r load-data}
# ------------------------------------------------------------------------------
# Load Required Data Files
# ------------------------------------------------------------------------------
# Load all data files needed for visualization
#
# DATA SOURCES:
# - districts_polygons_minimal.rds: Minimal district polygons for base map
#   Created by: Data prep for shiny app.Rmd
#   Used for: Base map background in visualizations
#
# - costa_rica_activity_tiles_population.geojson: Tile polygons with population
#   Created by: calculate_population_new_tiles.py
#   Used for: Showing tile boundaries and population data
#
# - activity_by_pop_tiles_overall_wgs84.geojson: Activity tiles with elevation
#   Created by: Process CR Mobility Data.Rmd
#   Used for: Getting elevation data to join with population tiles
#
# - malaria_cases_2023_points.rds: Spatial points for malaria cases
#   Created by: Data prep for shiny app.Rmd
#   Used for: Plotting case locations on maps
#
# - mobility_flows_with_elevation.rds: Mobility flow lines with elevation
#   Created by: Data prep for shiny app.Rmd
#   Used for: Visualizing travel patterns from case tiles

# Load minimal district polygons (for base map)
districts_min <- readRDS(file.path(data_dir, "districts_polygons_minimal.rds"))

# Load tile polygons with population estimates (GHSL 2025, WorldPop 2020)
pop_tiles <- st_read(file.path(data_dir, "costa_rica_activity_tiles_population.geojson"))

# Load activity tiles with elevation data (for joining elevation to pop_tiles)
mob <- st_read(file.path(data_dir, "activity_by_pop_tiles_overall_wgs84.geojson")) %>%
  st_make_valid() %>%
  st_transform(4326)

# Load malaria case spatial points
mal23_pts <- readRDS(file.path(data_dir, "malaria_cases_2023_points.rds"))

# Load flow lines with elevation data
flows_all_elev <- readRDS(file.path(data_dir, "mobility_flows_with_elevation.rds"))

# Clean up: remove proj_root (no longer needed)
rm(proj_root)
```

```{r prepare-flows}
# ------------------------------------------------------------------------------
# Prepare Flow Data for Visualization
# ------------------------------------------------------------------------------
# Filter flows to only outgoing flows from tiles with malaria cases
# This matches the logic from the data prep file

# Get case home tile lookup
case_home <- mal23_pts %>%
  st_drop_geometry() %>%
  dplyr::select(case_id, tile_id) %>%
  dplyr::distinct()

# Add people_travel and direction to flows
flows_all_elev <- flows_all_elev %>%
  dplyr::mutate(people_travel = visit_fraction * origin_pop) %>%
  dplyr::left_join(case_home, by = "case_id") %>%
  dplyr::rename(case_tile = tile_id) %>%
  dplyr::mutate(
    direction = dplyr::case_when(
      tile_o == case_tile ~ "Outgoing",
      tile_d == case_tile ~ "Incoming",
      TRUE                ~ NA_character_
    )
  )

# Filter cases (drop district centroid and San José cases)
cases_all <- mal23_pts %>%
  st_transform(4326) %>%
  dplyr::filter(
    locality_source != "district_centroid",
    PROVINCIA != "SAN JOSE"
  )

valid_case_ids <- unique(cases_all$case_id)

# Filter flows: valid cases, valid direction, elevation < 1000m
flows_slim <- flows_all_elev %>%
  dplyr::filter(
    case_id %in% valid_case_ids,
    !is.na(direction),
    !is.na(elev_o_ft), !is.na(elev_d_ft),
    elev_o_ft < 1000, elev_d_ft < 1000,
    tile_o != tile_d
  ) %>%
  dplyr::transmute(
    case_id,
    direction,
    case_tile,
    tile_o,
    tile_d,
    elev_o = elev_o_ft,
    elev_d = elev_d_ft,
    ds = as.Date(ds),
    people_travel,
    origin_pop,
    visit_fraction,
    geometry
  ) %>%
  st_as_sf(crs = 4326)

# Split flows by direction
flows_out_all <- flows_slim %>% dplyr::filter(direction == "Outgoing")

# Clean up: remove intermediate objects
rm(case_home, valid_case_ids, flows_all_elev, flows_slim, cases_all)
```

```{r create-static-figures}
# ------------------------------------------------------------------------------
# Create Static Malaria/Mobility Figures
# ------------------------------------------------------------------------------
# Create aliases for consistency
tiles_base <- pop_tiles
districts_base <- districts_min

# ------------------------------------------------------------------------------
# Figure 1: Malaria Cases and Connected Mobility Flows
# ------------------------------------------------------------------------------
# Prepare flows for visualization
flows_case_od <- flows_out_all

# Create flow categories based on quantiles (avoid issues if very small n)
if (nrow(flows_case_od) > 0) {
  brks <- quantile(flows_case_od$people_travel,
                   probs = c(0, 0.8, 0.95, 1),
                   na.rm = TRUE)
  # If quantiles collapse, jitter slightly
  brks[duplicated(brks)] <- brks[duplicated(brks)] + 1e-6
} else {
  brks <- c(0, 1, 2, 3)
}

flows_case_od <- flows_case_od %>%
  mutate(
    flow_cat = cut(
      people_travel,
      breaks = brks,
      include.lowest = TRUE,
      labels = c("small", "medium", "large")
    )
  )

# Sample small flows for visualization performance
set.seed(123)
small_n <- min(nrow(flows_case_od %>% filter(flow_cat == "small")), 3000)

small_flows <- flows_case_od %>%
  filter(flow_cat == "small") %>%
  slice_sample(n = small_n)

flows_case_plot <- bind_rows(
  small_flows,
  flows_case_od %>% filter(flow_cat != "small")
)

# Create flow visualization plot
p_flows <- ggplot() +
  # Base map: districts
  geom_sf(data = districts_min,
          fill = "grey97",
          color = "grey80",
          linewidth = 0.2) +
  # Tiles
  geom_sf(data = pop_tiles,
          fill = NA,
          color = "grey90",
          linewidth = 0.15) +
  # Flows – use the sampled / categorized df
  geom_sf(data = flows_case_plot,
          aes(linewidth = flow_cat,
              alpha    = flow_cat),
          color = "steelblue4",
          lineend = "round",
          show.legend = "line") +
  # Malaria cases as points
  geom_sf(data = mal23_pts,
          aes(color = "Malaria case"),
          size = 0.5,
          alpha = 0.9,
          show.legend = TRUE) +
  scale_linewidth_manual(
    name   = "Travel volume",
    values = c(
      "small"  = 0.1,
      "medium" = 0.4,
      "large"  = 0.8
    )
  ) +
  scale_alpha_manual(
    name   = "Travel volume",
    values = c(
      "small"  = 0.05,
      "medium" = 0.2,
      "large"  = 0.6
    )
  ) +
  scale_color_manual(
    name   = NULL,
    values = c("Malaria case" = "darkred")
  ) +
  coord_sf() +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank()
  ) +
  labs(
    title    = "Malaria cases and connected mobility flows",
    subtitle = "Flows shown only if origin or destination tile includes ≥1 malaria case"
  )

p_flows

# ------------------------------------------------------------------------------
# Figure 2: Malaria Cases Per Week (Faceted)
# ------------------------------------------------------------------------------
# Prepare cases by week for 2023
cases_week <- mal23_pts %>%
  mutate(
    symptom_onset = as.Date(`FECHA INICIO SÍNTOMAS`),
    year  = year(symptom_onset),
    week  = floor_date(symptom_onset, unit = "week")  # Monday-based weeks
  ) %>%
  filter(year == 2023)

# Static faceted map: malaria cases per week
p_cases_week <- ggplot() +
  geom_sf(data = tiles_base, fill = "grey95", color = "grey80", size = 0.1) +
  geom_sf(
    data  = cases_week,
    aes(color = week),
    size  = 1,
    alpha = 0.8
  ) +
  scale_color_viridis_c(option = "plasma", guide = "none") +
  coord_sf() +
  facet_wrap(~ week, ncol = 6) +   # 6 columns of weeks
  theme_minimal(base_size = 10) +
  theme(
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(
    title = "Malaria cases per week, 2023",
    subtitle = "Each panel shows cases in that week",
    x = NULL, y = NULL
  )

p_cases_week

# ------------------------------------------------------------------------------
# Figure 3: Interactive Map of Low-Elevation Tiles with Population
# ------------------------------------------------------------------------------
# Add elevation from mob to pop_tiles (drop mob geometry so we don't confuse sf)
pop_tiles_low <- pop_tiles %>%
  left_join(
    mob %>% st_drop_geometry() %>% select(tile_id, elev_min_m, activity),
    by = "tile_id"
  ) %>%
  filter(elev_min_m < 500)

# Create interactive leaflet map
m_pop_tiles <- leaflet(pop_tiles_low) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~colorNumeric(
      palette = "YlOrRd",
      domain  = log1p(pop_tiles_low$ghsl_population_2025)
    )(log1p(ghsl_population_2025)),
    fillOpacity = 0.7,
    color       = "grey40",
    weight      = 0.2
  )

m_pop_tiles

# Clean up: remove intermediate visualization objects
rm(flows_case_od, brks, small_n, small_flows, flows_case_plot, 
   cases_week, pop_tiles_low, tiles_base, districts_base, flows_out_all)
```

