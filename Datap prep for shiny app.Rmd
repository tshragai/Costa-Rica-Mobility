---
title: "Data prep for shiny app"
output: html_document
date: "2025-11-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#libraries
library(dplyr)
library(sf)
library(lubridate)
library(data.table)
library(terra)
library(elevatr)
library(purrr)

#project root and directory for data saves
proj_root <- "~/Costa-Rica-Mobility"
data_dir  <- file.path(proj_root, "Data")
```


```{r read in data I'll use}
setwd("~/Costa-Rica-Mobility/Data")

#malaria data with point locations
mal23_merged <- readRDS(file.path(data_dir, "mal23_merged.rds"))

#create points
mal23_pts <- mal23_merged %>%
  filter(!is.na(lon_final), !is.na(lat_final)) %>%
  mutate(case_id = row_number()) %>%
  st_as_sf(coords = c("lon_final", "lat_final"),
           crs = 4326,
           remove = FALSE)

saveRDS(mal23_pts,     file.path(data_dir, "mal23_pts.rds"))

################################################################################
#activity tiles 
mob <- st_read("activity_by_pop_tiles_overall_wgs84.geojson") %>%
  st_make_valid() %>%
  st_transform(4326)

#elevation per mobility tile
dem_r <- get_elev_raster(
  locations = mob,
  z   = 11,
  prj = st_crs(mob)$wkt,
  clip = "bbox"
)

dem       <- rast(dem_r)
mob_terra <- vect(mob)

tile_elev <- terra::extract(
  dem,
  mob_terra,
  fun   = min,
  na.rm = TRUE,
  ID    = FALSE
)

mob$elev_min_m  <- tile_elev[, 1]
mob$elev_min_ft <- mob$elev_min_m * 3.28084

################################################################################
#full mobility data
setwd("~/Downloads")
ca_aug <- fread(file.path(data_dir, "ca_aug.csv"))

################################################################################
#district polygons
setwd("~/Downloads/CR_district_population_GHSL_2025")
districts <- st_read("CR_district_population_GHSL_2025.shp") %>%
  st_make_valid()

# helpers 
norm_txt <- function(x) {
  x |>
    tolower() |>
    stringi::stri_trans_general("Latin-ASCII") |>
    trimws() |>
    gsub("\\s+", " ", x = _)
}
make_key <- function(prov, dist) paste(norm_txt(prov), norm_txt(dist), sep = " | ")

# NOMB_UGEP = Province, NOMB_UGED = District
districts_min <- districts %>%
  transmute(
    PROV_SHP = NOMB_UGEP,
    DIST_SHP = NOMB_UGED,
    geom     = geometry
  ) %>%
  mutate(key = make_key(PROV_SHP, DIST_SHP))

#save for reuse in Shiny
saveRDS(districts_min, file.path(data_dir, "districts_min.rds"))

################################################################################
#population per tile data
setwd("~/Costa-Rica-Mobility/Data")
pop_tiles <- st_read("costa_rica_activity_tiles_population.geojson")  

```

```{r more data prep}
# --------------------------------------------------------------------
#Assign each case to a mobility tile
# --------------------------------------------------------------------
mob_tiles <- mob %>% select(tile_id, geometry)

cases_tiles <- st_join(
  mal23_pts %>% select(case_id),
  mob_tiles,
  join = st_within,
  left  = FALSE               # drop cases not in any tile
) %>%
  st_drop_geometry() %>%
  distinct(case_id, tile_id) %>%
  group_by(case_id) %>%
  slice(1) %>%
  ungroup()

# (Optional) attach tile_id back to case points
mal23_pts <- mal23_pts %>%
  left_join(cases_tiles, by = "case_id")

# --------------------------------------------------------------------
#Tile centroids + elevation lookup
# --------------------------------------------------------------------
tile_centers <- mob %>%
  mutate(cent = st_centroid(geometry)) %>%
  mutate(
    lon = st_coordinates(cent)[, 1],
    lat = st_coordinates(cent)[, 2]
  ) %>%
  st_drop_geometry() %>%
  select(tile_id, lon, lat, elev_min_ft)

# --------------------------------------------------------------------
#Build flow lines (Outgoing & Incoming) with elevation
# --------------------------------------------------------------------
# OUTGOING: case tile is origin
flows_out_raw <- cases_tiles %>%
  inner_join(
    ca_aug,
    by = c("tile_id" = "o_tile_id")   # case tile matches origin tile
  ) %>%
  rename(
    tile_o = tile_id,    # origin tile (case)
    tile_d = d_tile_id   # destination tile
  )

# INCOMING: case tile is destination
flows_in_raw <- cases_tiles %>%
  inner_join(
    ca_aug,
    by = c("tile_id" = "d_tile_id")   # case tile matches destination tile
  ) %>%
  rename(
    tile_d = tile_id,    # destination tile (case)
    tile_o = o_tile_id   # origin tile
  )

make_flow_lines <- function(flows_df) {
  flows_df %>%
    # origin coords + elevation
    left_join(
      tile_centers %>%
        rename(
          lon_o     = lon,
          lat_o     = lat,
          elev_o_ft = elev_min_ft
        ),
      by = c("tile_o" = "tile_id")
    ) %>%
    # destination coords + elevation
    left_join(
      tile_centers %>%
        rename(
          lon_d     = lon,
          lat_d     = lat,
          elev_d_ft = elev_min_ft
        ),
      by = c("tile_d" = "tile_id")
    ) %>%
    filter(
      !is.na(lon_o), !is.na(lat_o),
      !is.na(lon_d), !is.na(lat_d)
    ) %>%
    mutate(
      geometry = purrr::pmap(
        list(lon_o, lat_o, lon_d, lat_d),
        ~ st_linestring(matrix(c(..1, ..3, ..2, ..4), ncol = 2, byrow = FALSE))
      )
    ) %>%
    st_as_sf(crs = 4326)
}

flows_out_sf <- make_flow_lines(flows_out_raw) %>%
  mutate(direction = "Outgoing")

flows_in_sf <- make_flow_lines(flows_in_raw) %>%
  mutate(direction = "Incoming")

# This is the object you'll feed to Shiny
flows_all_elev <- bind_rows(flows_out_sf, flows_in_sf)

# --------------------------------------------------------------------
#Save outputs for Shiny / downstream scripts
# --------------------------------------------------------------------
saveRDS(flows_all_elev, file.path(data_dir, "flows_all_elev.rds"))
```






More pre processing
```{r more pre processing}
# --------------------------------------------------------------------
# More pre processing: add people_travel and direction
# --------------------------------------------------------------------

# 1) Case home tile lookup (from mal23_pts which already has tile_id from earlier)
case_home <- mal23_pts %>%
  st_drop_geometry() %>%
  dplyr::select(case_id, tile_id) %>%
  dplyr::distinct()

# 2) Add people_travel + case_tile + direction to flows_all_elev
flows_all_elev <- flows_all_elev %>%
  # population-weighted people traveling for this record
  dplyr::mutate(people_travel = visit_fraction * origin_pop) %>%
  # attach the case's home tile
  dplyr::left_join(case_home, by = "case_id") %>%
  dplyr::rename(case_tile = tile_id) %>%
  # classify direction relative to the case tile
  dplyr::mutate(
    direction = dplyr::case_when(
      tile_o == case_tile ~ "Outgoing",
      tile_d == case_tile ~ "Incoming",
      TRUE                ~ NA_character_
    )
  )

# 3) Build slim object with direction + people_travel
flows_slim <- flows_all_elev %>%
  dplyr::transmute(
    case_id,
    direction,                 # "Incoming" / "Outgoing"
    case_tile,                 # tile where the case lives
    tile_o,
    tile_d,
    elev_o = elev_o_ft,
    elev_d = elev_d_ft,
    ds = as.Date(ds),
    people_travel,             
    origin_pop,
    visit_fraction,
    geometry
  ) %>%
  st_as_sf(crs = 4326)

# 4) Drop district centroid + San José cases and apply elevation filters
cases_all <- mal23_pts %>%
  st_transform(4326) %>%
  dplyr::filter(
    locality_source != "district_centroid",
    PROVINCIA != "SAN JOSE"
  ) %>%
  dplyr::mutate(symptom_onset = as.Date(`FECHA INICIO SÍNTOMAS`)) %>%
  dplyr::select(case_id, PROVINCIA, symptom_onset, geometry, locality_source)

valid_case_ids <- unique(cases_all$case_id)

flows_slim <- flows_slim %>%
  dplyr::filter(
    case_id %in% valid_case_ids,
    !is.na(direction),
    !is.na(elev_o), !is.na(elev_d),
    elev_o < 1000, elev_d < 1000,
    tile_o != tile_d          # drop zero-length trips
  )

# 5) Split trips in and out
flows_in_all  <- flows_slim %>% dplyr::filter(direction == "Incoming")
flows_out_all <- flows_slim %>% dplyr::filter(direction == "Outgoing")

#Calculate trips per week window

# 1. Make sure dates are Date and define the "index week" for each case
cases_all_weeks <- cases_all %>%
  mutate(
    symptom_onset = as.Date(symptom_onset),
    week_start    = floor_date(symptom_onset, unit = "week")
  )

# All unique index weeks present in the data
all_weeks <- cases_all_weeks %>%
  filter(!is.na(week_start)) %>%
  distinct(week_start) %>%
  arrange(week_start) %>%
  pull(week_start)

# 2. For each week_start, compute OUTGOING travel from cases in that week
#    AND the following two weeks (21 days total).
#
# Result: one row per (week_start, tile_id) with summed people_travel
#         where tile_id is the DESTINATION tile (tile_d).

travel_df_week <- purrr::map_dfr(all_weeks, function(wk) {
  
  window_start <- wk
  window_end   <- wk+6   
  
  # case_ids with onset in [week_start, week_start + 20 days]
  case_ids_window <- cases_all_weeks %>%
    filter(
      !is.na(symptom_onset),
      symptom_onset >= window_start,
      symptom_onset <= window_end
    ) %>%
    pull(case_id) %>%
    unique()
  
  if (length(case_ids_window) == 0) {
    return(NULL)
  }
  
  # OUTGOING ONLY: from case tile to destination tile_d
  flows_out_all %>%
    filter(case_id %in% case_ids_window) %>%
    st_drop_geometry() %>%
    group_by(
      week_start = wk,     # index week this window is anchored on
      tile_id    = tile_d  # destination tile
    ) %>%
    summarise(
      people = sum(people_travel, na.rm = TRUE),
      .groups = "drop"
    )
})

#save data for shiny app

setwd("~/Costa-Rica-Mobility/Visualize_CR_mobility_data/Data")
shiny_data <- list(
  districts_base = districts_base,
  #flows_slim = flows_slim,
  cases_all      = cases_all,
  #flows_in_all   = flows_in_all,
  #flows_out_all  = flows_out_all,
  tiles_base = pop_tiles,
  travel_df_week=travel_df_week
)

saveRDS(shiny_data, "shiny_mobility_data.rds")
```


static map
```{r static map}


flows_case_od <- flows_out_all

# avoid issues if very small n
if (nrow(flows_case_od) > 0) {
  brks <- quantile(flows_case_od$people_travel,
                   probs = c(0, 0.8, 0.95, 1),
                   na.rm = TRUE)
  # if quantiles collapse, jitter slightly
  brks[duplicated(brks)] <- brks[duplicated(brks)] + 1e-6
} else {
  brks <- c(0, 1, 2, 3)
}

flows_case_od <- flows_case_od %>%
  mutate(
    flow_cat = cut(
      people_travel,
      breaks = brks,
      include.lowest = TRUE,
      labels = c("small", "medium", "large")
    )
  )

set.seed(123)

small_n <- min(nrow(flows_case_od %>% filter(flow_cat == "small")), 3000)

small_flows <- flows_case_od %>%
  filter(flow_cat == "small") %>%
  slice_sample(n = small_n)

flows_case_plot <- bind_rows(
  small_flows,
  flows_case_od %>% filter(flow_cat != "small")
)


p_flows <- ggplot() +
  # base map
  geom_sf(data = districts_min,
          fill = "grey97",
          color = "grey80",
          linewidth = 0.2) +
  
  # tiles
  geom_sf(data = pop_tiles,
          fill = NA,
          color = "grey90",
          linewidth = 0.15) +
  
  # highlight tiles that have malaria cases (optional but nice)
  #geom_sf(data = case_tiles_sf,
         # fill = NA,
         # color = "firebrick",
         # linewidth = 0.4) +
  
  # flows – use the sampled / categorized df
  geom_sf(data = flows_case_plot,
          aes(linewidth = flow_cat,
              alpha    = flow_cat),
          color = "steelblue4",
          lineend = "round",
          show.legend = "line") +
  
  # malaria cases as points
  geom_sf(data = mal23_pts,
          aes(color = "Malaria case"),
          size = 0.5,
          alpha = 0.9,
          show.legend = TRUE) +
  
  scale_linewidth_manual(
    name   = "Travel volume",
    values = c(
      "small"  = 0.1,
      "medium" = 0.4,
      "large"  = 0.8
    )
  ) +
  scale_alpha_manual(
    name   = "Travel volume",
    values = c(
      "small"  = 0.05,
      "medium" = 0.2,
      "large"  = 0.6
    )
  ) +
  scale_color_manual(
    name   = NULL,
    values = c("Malaria case" = "darkred")
  ) +
  coord_sf() +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank()
  ) +
  labs(
    title    = "Malaria cases and connected mobility flows",
    subtitle = "Flows shown only if origin or destination tile includes ≥1 malaria case"
  )

p_flows
```
```{r static map}

cases_week <- mal23_pts %>%
  mutate(
    symptom_onset = as.Date(`FECHA INICIO SÍNTOMAS`),
    year  = year(symptom_onset),
    week  = floor_date(symptom_onset, unit = "week")  # Monday-based weeks
  ) %>%
  filter(year == 2023)   # <-- change year as needed

# 2. Static faceted map: malaria cases per week
ggplot() +
  geom_sf(data = tiles_base, fill = "grey95", color = "grey80", size = 0.1) +
  geom_sf(
    data  = cases_week,
    aes(color = week),
    size  = 1,
    alpha = 0.8
  ) +
  scale_color_viridis_c(option = "plasma", guide = "none") +
  coord_sf() +
  facet_wrap(~ week, ncol = 6) +   # 6 columns of weeks
  theme_minimal(base_size = 10) +
  theme(
    panel.grid.major = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  labs(
    title = "Malaria cases per week, 2023",
    subtitle = "Each panel shows cases in that week",
    x = NULL, y = NULL
  )

# add elevation from mob to pop_tiles (drop mob geometry so we don't confuse sf)
pop_tiles_low <- pop_tiles %>%
  left_join(
    mob %>% st_drop_geometry() %>% select(tile_id, elev_min_m,activity),
    by = "tile_id"
  ) %>%
  filter(elev_min_m < 500)

leaflet(pop_tiles_low) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~colorNumeric(
      palette = "YlOrRd",
      domain  = log1p(pop_tiles_low$ghsl_population_2025)
    )(log1p(ghsl_population_2025)),
    fillOpacity = 0.7,
    color       = "grey40",
    weight      = 0.2
  )
```
Static graph
```{r static graph}
setwd("~/Costa-Rica-Mobility/Data")
flows_all_elev<-readRDS("flows_all_elev.rds")
#population per tile data
setwd("~/Costa-Rica-Mobility/Data")
pop_tiles <- st_read("costa_rica_activity_tiles_population.geojson")
mob <- st_read("activity_by_pop_tiles_overall_wgs84.geojson") %>%
  st_make_valid() %>%
  st_transform(4326)
#malaria data with point locations
mal23_merged <- readRDS(file.path(data_dir, "mal23_merged.rds"))
#create points
mal23_pts <- mal23_merged %>%
  filter(!is.na(lon_final), !is.na(lat_final)) %>%
  mutate(case_id = row_number()) %>%
  st_as_sf(coords = c("lon_final", "lat_final"),
           crs = 4326,
           remove = FALSE)


# add elevation from mob to pop_tiles (drop mob geometry so we don't confuse sf)
pop_tiles_low <- pop_tiles %>%
  left_join(
    mob %>% st_drop_geometry() %>% select(tile_id, elev_min_m,activity),
    by = "tile_id"
  ) %>%
  filter(elev_min_m < 1000)

cases_weekly <- mal23_pts %>%
  mutate(
    case_date = as.Date(date),
    week_start = floor_date(case_date, unit = "week")
  ) %>%
  group_by(tile_id, week_start) %>%      # tile_id must match tiles_base
  summarise(cases_in_tile = n(), .groups = "drop")

flows_static <- flows_all_elev %>%
  select(tile_origin, tile_destination, people)

case_tiles_by_week <- cases_weekly %>%
  group_by(week_start) %>%
  summarise(case_tiles = list(tile_id), .groups = "drop")
```

